{% load generic_filters %}
<div style="display:none">
<div id="flag-dialog" title="Flag this post">
    <form id="flag-dialog-form" method="POST" action="{% url moderation_report %}" style="width: 400px">
        <input type="hidden" id="flag-dialog-asset-id" name="asset-id" value="" />
        <input type="hidden" name="return_to" value="{{ request.path }}" />
        <fieldset>
            <p>Please select a category that most closely reflects your
            concern about this post.</p>
            <ul>
                <select name="reason">
                    <option value="">Select one...</option>
                    {% for option in settings.report_options %}
                    {% if not option.0|regex_search:"^-" %}
                    {% if request.user.is_superuser %}
                    <option value="{{ forloop.counter0 }}">{{ option.0 }}</option>
                    {% else %}
                    {% if not option.0|regex_search:"^Admin" %}
                    <option value="{{ forloop.counter0 }}">{{ option.0 }}</option>
                    {% endif %}
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                </select>
            </ul>
        </fieldset>
        <fieldset>
            <label for="flag-dialog-note">Note for moderator:</label>
            <input id="flag-dialog-note" name="note" type="text" maxlength="140" />
        </fieldset>
        <p>Our moderator will review your request and determine if it
        violates any of our guidelines or is inappropriate. Abusing this
        feature may results in your account being permanently banned from this
        site.</p>
    </form>
</div>
</div>

<script type="text/javascript">
    $(document).ready(function() {
        $("#flag-dialog").dialog({
            modal: true,
            autoOpen: false,
            resizable: false,
            width: 420,
            height: 220,
            buttons: {
                "Flag": function() { $("#flag-dialog-form").submit(); },
                "Cancel": function() { $(this).dialog("close"); }
            }
        });
        $('#flag-dialog-form').ajaxForm({
            beforeSubmit: function() {
                $("#flag-dialog").dialog('close');
                var xid = $("#flag-dialog-asset-id").val();
                var btn = $("#flag-" + xid + " button");
                btn.hide().next().show();
            },
            success: function(responseText, statusText) {
                if (responseText == "OK") {
                    var xid = $("#flag-dialog-asset-id").val();
                    $("#flag-" + xid + " button").addClass("flagged");
                } else {
                    alert(responseText);
                }
                var btn = $("#flag-" + xid + " button");
                btn.show().next().hide();
            }
        });
    });
    function flagasset(xid) {
        if ($("#flag-" + xid + " button").hasClass("flagged"))
            return;
        // reset form
        $(':input','#flag-dialog-form').not(':button, :submit, :reset, :hidden').val('').removeAttr('checked').removeAttr('selected');
        $("#flag-dialog-asset-id").val(xid);
        $("#flag-dialog").dialog('open');
    }
</script>
